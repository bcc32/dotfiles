#!/usr/bin/env bash

set -eu

if [ $# -ne 1 ]; then
  echo >&2 "Usage: $0 OUTFILE"
  exit 2
fi

outfile=$1

if [ -e "$outfile" ] && ! [ -f "$outfile" ]; then
  echo >&2 "Exists and is not a regular file: $outfile"
  exit 1
fi

tmpfile=$(mktemp -- "$outfile.XXXXXX")
trap 'rm -f -- "$tmpfile"' EXIT

if [ -e "$outfile" ]; then
  chmod --reference="$outfile" -- "$tmpfile"
fi
cat >"$tmpfile"
mv -Tf -- "$tmpfile" "$outfile"

trap - EXIT
