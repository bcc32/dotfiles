#!/usr/bin/env bash

set -o errexit -o nounset

# Prevent ~/.offlineimap.py from being cached and creating ~/__pycache__/
# https://stackoverflow.com/questions/50752302/python3-pycache-generating-even-if-pythondontwritebytecode-1
export PYTHONDONTWRITEBYTECODE=1

if ~/bin/,am-online; then
  if [ -n "$(find ~/.last-successful-offlineimap-full-sync -mmin -10)" ]; then
    flags=(-q)
    touch_full_sync_when_done=0
  else
    flags=()
    touch_full_sync_when_done=1
  fi
  set -o xtrace
  timeout -k 1m 2m offlineimap "${flags[@]}"
  if ((touch_full_sync_when_done)); then
    touch ~/.last-successful-offlineimap-full-sync
  fi
else
  echo >&2 "No Internet connection"
  exit 1
fi
