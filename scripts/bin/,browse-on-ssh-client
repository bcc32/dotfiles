#!/usr/bin/env bash

set -eux

url=$1
ssh_client_ip=${SSH_CONNECTION%% *}

if [[ $url == http* ]]; then
  file=$(mktemp --tmpdir browse-on-ssh-client.XXXXXX)
  trap 'rm -f "$file"' EXIT
  cat >"$file" <<EOF
[InternetShortcut]
URL=$url
EOF
  dest_file_basename="$(uuid -v4).url"
elif [[ $url == file:///* ]]; then
  if command -v trurl >/dev/null 2>/dev/null; then
    file=$(trurl --get='[path]' "$url")
  else
    # do our best if trurl is not available
    file=${url#file://}
  fi
  dest_file_basename=
elif [[ $url == /* ]]; then
  file=$url
  dest_file_basename=
else
  echo >&2 "Unrecognized URL type: $url"
  exit 1
fi

ssh_options=(
  -o ControlMaster=yes
  -o ControlPath=/tmp/browse-on-ssh-client-%C
  -o ControlPersist=5s
)

scp "${ssh_options[@]}" -q "$file" "$ssh_client_ip:.links-to-open/$dest_file_basename"
